@page "/DataTable"
@using Microsoft.EntityFrameworkCore
@using System.Collections.Generic
@using RunTogether.Data
@using RunTogether.Pages
@using Microsoft.AspNetCore.Identity
@using RunTogether.Areas.Identity.Helpers
@using RunTogether.Areas.Identity
@using RunTogether.Shared.QR

@inject ApplicationDbContext dbContext
@inject UserManager<ApplicationUser> userManager
@inject DialogService dialogService

<h3>DataTable</h3>

<RadzenButton Text=@($"Opret nyt løb") Click="@ShowSimpleDialog" />
<div class="row">
    <div class="col-md-6">
        <RadzenGrid @ref="table" Data="@runs" AllowFiltering="true" AllowSorting="true" TItem="Run" RowSelect="@(args => fuckvs(args))">
            <Columns>
                <RadzenGridColumn TItem="Run" Property="ID" Title="ID"></RadzenGridColumn>
                <RadzenGridColumn TItem="Run" Property="StartDate" Title="Start Date"></RadzenGridColumn>
                <RadzenGridColumn TItem="Run" Property="EndDate" Title="End Date"></RadzenGridColumn>
                <RadzenGridColumn TItem="Run" Property="Route" Title="Route"></RadzenGridColumn>
            </Columns>
        </RadzenGrid>
    </div>
    <div class="col-md-6">
        <RadzenTabs>
            <Tabs>
                <RadzenTabsItem Text="Runners">
                    <RadzenGrid AllowFiltering="true" AllowPaging="true" AllowSorting="true" Data="@runners" TItem="ApplicationUser">
                        <Columns>
                            <RadzenGridColumn TItem="ApplicationUser" Property="runners.FirstName" Title="Efternavn" />
                            <RadzenGridColumn TItem="ApplicationUser" Property="runners.LastName" Title="Fornavn" />
                            <RadzenGridColumn TItem="ApplicationUser" Property="runners.Email" Title="Email" />
                        </Columns>
                    </RadzenGrid>
                </RadzenTabsItem>

                <RadzenTabsItem Text="Route">
                    <RadzenDataList WrapItems="true" AllowPaging="true" Data="@runners" TItem="ApplicationUser" PageSize="10">
                        <Template Context="detail">
                            <RadzenCard Style="width:100px;height:100px">
                                Product:
                                <b>@detail?.Email</b>
                            </RadzenCard>
                        </Template>
                    </RadzenDataList>
                </RadzenTabsItem>

                <RadzenTabsItem Text="QR Kode">
                    <div style=" display: block; margin-left: auto; margin-right: auto;">
                    <QRGenerator code="ITSWORKING!" size="50%" />
                    </div>               
                </RadzenTabsItem>
            </Tabs>
        </RadzenTabs>
    </div>
</div>




@code {



    //Delecare variable for referencing radzen table (@ref="table") as RadzenGrid of type Run 
    RadzenGrid<Run> table;

    //henter hele data table ned og filtere client-side, men der laves ingen filtering her, så det er fint.
    IEnumerable<Run> runs;

    //alt querying bliver laver i DB og kun det relevante data sendes til client.
    IQueryable<ApplicationUser> runners;


    protected override async Task OnInitializedAsync()
    {
        runs = dbContext.Runs;
        var test = new UserCreationHelper(userManager, dbContext);
<<<<<<< Updated upstream
=======
        //Console.WriteLine(runs.ElementAt(2).StartDate);
    }

    protected override void OnInitialized()
    {


>>>>>>> Stashed changes

        await test.CreateRunner("test", "123", "he123123j@gmail.com", runs.ElementAt<Run>(2));
    }

    public void QueryForRunners(Run QueryRun)
    {
        runners = dbContext.Users
            .Where(u => u.RunId == QueryRun.ID);
    }

    //Code for create Run dialog. 
    Run run = new Run();

    async Task ShowSimpleDialog() => await dialogService.OpenAsync("Simple Dialog", ds =>
    @<RadzenTemplateForm TItem="Run" Data="@run" Submit="()=> OnSubmit(run.StartDate, run.EndDate)" InvalidSubmit="()=> OnInvalidSubmit()">

        <div class="row" style="margin-bottom: 48px">
            <div class="col-md-4 align-right">
                <RadzenLabel Text="Start date" />
            </div>
            <div class="col">
                <RadzenDatePicker Name="StartDate" DateFormat="d" @bind-Value="run.StartDate" /><br>
                <RadzenRequiredValidator Component="StartDate" Text="Start date is required" Popup=true Style="position: absolute" />
            </div>
        </div>

        <div class="row" style="margin-bottom: 48px">
            <div class="col-md-4 align-right">
                <RadzenLabel Text="End date" />
            </div>
            <div class="col">
                <RadzenDatePicker Name="EndDate" DateFormat="d" @bind-Value="run.EndDate" /><br>
                <RadzenRequiredValidator Component="EndDate" Text="End date is required" Popup=true Style="position: absolute" />
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <RadzenButton ButtonType="ButtonType.Submit" Text="OK" Style="margin-bottom: 10px; width: 150px" />
                <RadzenButton Click="()=> ds.Close(false)" ButtonStyle="ButtonStyle.Secondary" Text="Cancel" Style="margin-bottom: 10px; width: 150px" />
            </div>
        </div>
    </RadzenTemplateForm>
    );


    public void OnSubmit(DateTime Start, DateTime End)
    {
        Run RunObj = new Run() { StartDate = Start, EndDate = End };
        Console.WriteLine("YEY!");
        this.dialogService.Close(true);
        dbContext.Runs.Add(RunObj);
        dbContext.SaveChanges();
        table.Reload();

    }

    void OnInvalidSubmit()
    {
        Console.WriteLine("AW");
    }

}
